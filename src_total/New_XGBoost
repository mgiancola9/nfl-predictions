import xgboost as xgb
import preprocess_chrono_weekly as preprocess
import numpy as np
import pandas as pd
import os

# --- CONFIGURATION ---
FEATURE_COLUMNS = [
    'total_line', 'spread_line', 'week', 'temp', 'wind', 'away_rest', 'home_rest',
    'away_avg_passing_epa', 'home_avg_passing_epa_allowed',
    'away_avg_rushing_epa', 'home_avg_rushing_epa_allowed',
    'home_avg_passing_epa', 'away_avg_passing_epa_allowed',
    'home_avg_rushing_epa', 'away_avg_rushing_epa_allowed',
    'away_avg_points_scored', 'home_avg_points_allowed',
    'home_avg_points_scored', 'away_avg_points_allowed'
]

def run_xgboost_regression():
    print("--- 1. Loading & Preprocessing Data ---")
    # Load the single source of truth
    # Make sure 'games_2016_2025.csv' is the file created by pull_data.py
    full_data = preprocess.merge_data("games_2016_2025.csv")
    
    # Create Target
    full_data['actual_total'] = full_data['home_score'] + full_data['away_score']
    
    # --- SPLIT DATA ---
    # Training: Games that have been played (have a score)
    # Prediction: Games that have NOT been played (score is NaN)
    
    train_df = full_data[full_data['actual_total'].notna()].copy()
    future_df = full_data[full_data['actual_total'].isna()].copy()

    print(f"Training Set: {len(train_df)} games")
    print(f"Games to Predict: {len(future_df)} games")

    if train_df.empty:
        raise ValueError("No training data found! Check your data pipeline.")

    # Prepare Training Data
    X_train = train_df[FEATURE_COLUMNS].values
    y_train = train_df['actual_total'].values

    # --- TRAIN MODEL ---
    print("\n--- 2. Training Model ---")
    model = xgb.XGBRegressor(
        objective='reg:squarederror',
        n_estimators=2000,
        learning_rate=0.005,
        max_depth=4,
        early_stopping_rounds=50,
        n_jobs=-1,
        random_state=42
    )
    
    # We use the last 10% of training data as a validation set for early stopping
    split_idx = int(len(X_train) * 0.9)
    X_tr, y_tr = X_train[:split_idx], y_train[:split_idx]
    X_val, y_val = X_train[split_idx:], y_train[split_idx:]
    
    model.fit(
        X_tr, y_tr,
        eval_set=[(X_val, y_val)],
        verbose=False
    )
    print("Training Complete.")

    # --- PREDICT FUTURE GAMES ---
    if future_df.empty:
        print("No upcoming games found to predict.")
        return

    print("\n--- 3. Predicting Upcoming Games ---")
    X_future = future_df[FEATURE_COLUMNS].values
    predictions = model.predict(X_future)
    
    future_df['predicted_total'] = predictions
    future_df['edge'] = future_df['predicted_total'] - future_df['total_line']
    
    # Output Results
    cols_to_show = ['season', 'week', 'away_team', 'home_team', 'total_line', 'predicted_total', 'edge']
    results = future_df[cols_to_show].sort_values('edge', ascending=False)
    
    print(results.to_string(index=False))
    
    # Optional: Save to CSV
    # results.to_csv("upcoming_predictions.csv", index=False)

if __name__ == "__main__":
    run_xgboost_regression()